"use strict";var App=App||{},google=google;App.init=function(){this.apiUrl="https://vanc-app.herokuapp.com/api",this.$main=$("main"),this.$modalContent=$(".modal-content"),this.$sidebar=$(".sidebar"),this.$recommended=$(".recommended"),this.$fullImage=$(".full-image"),this.markersArray=[],$(".logout").on("click",this.logout.bind(this)),$(".title").on("click",this.welcome.bind(this)),$(".featured").on("click",this.featuredRestaurant),$(".home-icon").on("click",this.toggleSidebar),this.$modalContent.on("submit","form",this.handleForm),this.$main.on("click",".add",this.addChoiceToSidebar),this.$recommended.on("click",".close",this.closeFeatures),$(".option").on("click",this.getChoice.bind(this)),this.getToken()?this.loggedInState():this.loggedOutState(),this.mapSetup()},App.addChoiceToSidebar=function(e){$.each(App.markersArray,function(e,t){t.setMap(null)});var t=$(e.target).parent(),n='\n    <div class="choice">\n      <img src='+t.find("img").attr("src")+">\n      <h4>"+t.find("h2").html()+"</h4>\n      <p>"+t.find("p").html()+"</p>\n    </div>\n  ";$(".selected").html(n).removeClass("selected")},App.getChoice=function(e){$(e.target).addClass("selected");var t=e.target.id;$(".userOptions").show(),$("select").on("change",function(){App.getRestaurants(t),$.each(App.markersArray,function(e,t){t.setMap(null)})})},App.addInfoWindowForRestaurant=function(e,t){var n=this;google.maps.event.addListener(t,"click",function(){"undefined"!=typeof n.infoWindow&&n.infoWindow.close(),n.infoWindow=new google.maps.InfoWindow({content:"<div class='infoWindow'>\n                  <img src="+e.restaurant.featured_image+">\n                  <h2>"+e.restaurant.name+"</h2>\n                  <h3>User Rating: "+e.restaurant.user_rating.aggregate_rating+"</h3>\n                  <h3>"+e.restaurant.cuisines+'</h3>\n                  <a href="'+e.restaurant.url+'">Visit Website</a>\n                  <br>\n                  <br>\n                  <p>'+e.restaurant.location.address+"</p>\n\n                  <button class='add' type='button' name='button'>Add</button>\n                </div>"}),n.infoWindow.open(n.map,t)})},App.createMarkerForRestaurant=function(e){var t="../images/icon3.png",n=new google.maps.LatLng(e.restaurant.location.latitude,e.restaurant.location.longitude),o=new google.maps.Marker({position:n,map:this.map,icon:t,animation:google.maps.Animation.DROP});App.markersArray.push(o),this.addInfoWindowForRestaurant(e,o)},App.resetMap=function(e){var t=new google.maps.LatLng(e.restaurant.location.latitude,e.restaurant.location.longitude);App.map.panTo(t)},App.loopThroughRestaurants=function(e){console.log(e),$.each(e.restaurants,function(e,t){setTimeout(function(){0===e&&App.resetMap(t),App.createMarkerForRestaurant(t)},100*e)})},App.getRestaurants=function(e){$(".userOptions").hide();var t={98130:"Yaletown",98137:"Gastown",98135:"Downtown",98139:"Kitsilano",98129:"Main Street"},n={breakfast:"8",lunch:"9",dinner:"2"},o=$(".neighbourhood").val(),a=t[o],i=n[e];$.get({url:"https://developers.zomato.com/api/v2.1/search?entity_id="+o+"&entity_type=subzone&q="+a+"&count=15&radius=700&category="+i+"&sort=rating&order=desc",headers:{"user-key":"a076d160e3eff25d9c8448aa2c2dc85b"}}).done(App.loopThroughRestaurants)},App.mapSetup=function(){var e=document.getElementById("map-canvas"),t={zoom:13,center:new google.maps.LatLng(49.2824303,(-123.126847)),mapTypeId:google.maps.MapTypeId.ROADMAP,styles:[{featureType:"all",stylers:[{saturation:0},{hue:"#e7ecf0"}]},{featureType:"road",stylers:[{saturation:-70}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"water",stylers:[{visibility:"simplified"},{saturation:-60}]}]};this.map=new google.maps.Map(e,t)},App.loggedInState=function(){$(".loggedIn").show(),$(".loggedOut").hide(),$(".recommended").hide(),this.$fullImage.hide()},App.loggedOutState=function(){$(".loggedIn").hide(),$(".loggedOut").show(),$(".sidebar").hide(),$(".recommended").hide(),this.$fullImage.show(),this.$modalContent.addClass("welcome"),this.$modalContent.html("\n    <div class='modal-header'>\n    <h3 class='modal-title'>Feeling hungry?</h3>\n    </div>\n    <div class='modal-body'>\n    <h6>You're in luck! Vancouver is famous for having <span>the best food</span> in the world... Click on the start button at the top left of the page to find the highest rated restaurants in any neighbourhood and add them to your day meal planner.</h6>\n    <p>But first please register or login:</p>\n    <button type='button' name='button' class='register'>Register</button>\n    <button type='button' name='button' class='login'>Log In</button>\n    </div>"),setTimeout(function(){$(".modal").modal("show")},1500),$(".register").on("click",this.register.bind(this)),$(".login").on("click",this.login.bind(this))},App.register=function(e){e&&e.preventDefault(),this.$modalContent.html("\n    <form method='post' action='/register'>\n      <div class='modal-header'>\n        <h4 class='modal-title'>Register</h4>\n      </div>\n      <div class='modal-body'>\n        <div class='form-group'>\n          <input class='form-control' type='text' name='user[username]' placeholder='Username'>\n        </div>\n        <div class='form-group'>\n          <input class='form-control' type='email' name='user[email]' placeholder='Email'>\n        </div>\n        <div class='form-group'>\n          <input class='form-control' type='password' name='user[password]' placeholder='Password'>\n        </div>\n        <div class='form-group'>\n          <input class='form-control' type='password' name='user[passwordConfirmation]' placeholder='Password Confirmation'>\n        </div>\n        <input class='btn btn-primary' type='submit' value='Register'>\n      </div>\n    </form>"),$(".modal").modal("show")},App.login=function(e){e.preventDefault(),this.$modalContent.addClass("logginginbox"),this.$modalContent.html("\n    <form method='post' action='/login'>\n    <div class='modal-header'>\n      <h4 class='modal-title'>Login</h4>\n    </div>\n    <div class='modal-body'>\n      <div class='form-group'>\n      <input class='form-control' type='email' name='email' placeholder='Email'>\n    </div>\n    <div class='form-group'>\n      <input class='form-control' type='password' name='password' placeholder='Password'>\n    </div>\n    <input class='btn btn-primary' type='submit' value='Login'>\n  </form>"),$(".modal").modal("show")},App.logout=function(e){e.preventDefault(),this.removeToken(),this.loggedOutState()},App.welcome=function(e){e.preventDefault(),this.loggedOutState()},App.handleForm=function(e){e.preventDefault(),$(".modal").modal("hide");var t=""+App.apiUrl+$(this).attr("action"),n=$(this).attr("method"),o=$(this).serialize();return App.ajaxRequest(t,n,o,function(e){e.token&&App.setToken(e.token),App.loggedInState()})},App.ajaxRequest=function(e,t,n,o){return $.ajax({url:e,method:t,data:n,beforeSend:this.setRequestHeader.bind(this)}).done(o).fail(function(e){console.log(e)})},App.setRequestHeader=function(e){return e.setRequestHeader("Authorization","Bearer "+this.getToken())},App.setToken=function(e){return window.localStorage.setItem("token",e)},App.getToken=function(){return window.localStorage.getItem("token")},App.removeToken=function(){return window.localStorage.clear()},App.toggleSidebar=function(){$(".sidebar").toggleClass("open-sidebar close-sidebar")},App.closeSidebar=function(){$(".sidebar").hide()},App.featuredRestaurant=function(){$(".recommended").show(),$(".recommended").html("\n    <button type='button' class='close' data-dismiss='modal' aria-label='Close'><span aria-hidden='true'>&times;</span></button>\n    <h4>Pick of the week:</h4>\n    <img src=\"../images/medina.jpg\">\n    <h6>Cafe Medina, Downtown</h6>\n    <p>Lavender lattes and belgium waffles</p>\n")},App.closeFeatures=function(){$(".recommended").hide()},$(App.init.bind(App));